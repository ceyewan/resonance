# =============================================================================
# Resonance 服务编排配置
#
# 本地开发模式：
#   docker compose -p resonance -f deploy/base.yaml -f deploy/services.yaml up -d
#   - 暴露 Gateway (8080) 和 Web (4173) 端口到 127.0.0.1
#   - 不使用 Caddy
#
# 生产模式（使用宿主机 Caddy）：
#   docker compose -p resonance -f deploy/base.yaml -f deploy/services.yaml --profile production up -d
#   - 建议将 GATEWAY_PORT_BINDING / WEB_PORT_BINDING 置空
#   - 通过 Caddy labels 让宿主机 Caddy 反向代理
#   - Watchtower 仅在 production profile 启用
# =============================================================================

x-resonance-build: &resonance-build
  context: ..
  dockerfile: deploy/Dockerfile
  target: final

x-resonance-service: &resonance-service
  image: ${RESONANCE_IMAGE:-ceyewan/resonance:local}
  build: *resonance-build
  environment: &resonance-env # 环境配置
    RESONANCE_ENV: ${RESONANCE_ENV:-}
    RESONANCE_DEBUG_CONFIG: ${RESONANCE_DEBUG_CONFIG:-false}
    # PostgreSQL 配置
    RESONANCE_POSTGRES_PASSWORD: ${RESONANCE_POSTGRES_PASSWORD:-}
    # JWT 认证配置
    RESONANCE_AUTH_SECRET_KEY: ${RESONANCE_AUTH_SECRET_KEY:-}
    RESONANCE_AUTH_ISSUER: ${RESONANCE_AUTH_ISSUER:-}
    RESONANCE_AUTH_ACCESS_TOKEN_TTL: ${RESONANCE_AUTH_ACCESS_TOKEN_TTL:-}
  networks:
    - resonance-net
  restart: unless-stopped

services:
  init:
    <<: *resonance-service
    container_name: resonance-init
    command: ["-module", "init"]
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      <<: *resonance-env
      RESONANCE_POSTGRES_HOST: postgres
      # 管理员账号（从环境变量读取）
      RESONANCE_ADMIN_USERNAME: ${RESONANCE_ADMIN_USERNAME:-}
      RESONANCE_ADMIN_PASSWORD: ${RESONANCE_ADMIN_PASSWORD:-}
      RESONANCE_ADMIN_NICKNAME: ${RESONANCE_ADMIN_NICKNAME:-}
    restart: "no"  # 一次性任务，执行完不重启
    labels:
      com.centurylinklabs.watchtower.enable: "false"  # 不需要自动更新

  logic:
    <<: *resonance-service
    hostname: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
      RESONANCE_POSTGRES_HOST: postgres
    container_name: resonance-logic
    command: ["-module", "logic"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      etcd:
        condition: service_healthy
      nats:
        condition: service_healthy
    labels:
      com.centurylinklabs.watchtower.enable: "true"

  gateway:
    <<: *resonance-service
    hostname: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    container_name: resonance-gateway
    command: ["-module", "gateway"]
    depends_on:
      redis:
        condition: service_healthy
      etcd:
        condition: service_healthy
      nats:
        condition: service_healthy
    # 本地开发：暴露端口；生产环境：通过 Caddy labels
    ports:
      - "${GATEWAY_PORT_BINDING:-127.0.0.1:8080:8080}"
    networks:
      - resonance-net
      - caddy
    labels:
      # 生产环境 Caddy 配置（当域名变量不为空时生效）
      caddy: ${CADDY_GATEWAY_DOMAIN:-}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.encode: gzip
      # Watchtower 自动更新
      com.centurylinklabs.watchtower.enable: "true"

  task:
    <<: *resonance-service
    hostname: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
      RESONANCE_POSTGRES_HOST: postgres
    container_name: resonance-task
    command: ["-module", "task"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
      etcd:
        condition: service_healthy
    labels:
      com.centurylinklabs.watchtower.enable: "true"

  web:
    <<: *resonance-service
    hostname: ${RESONANCE_WEB_HOSTNAME:-web-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_WEB_HOSTNAME:-web-service-001}
    container_name: resonance-web
    command: ["-module", "web"]
    # 本地开发：暴露端口；生产环境：通过 Caddy labels
    ports:
      - "${WEB_PORT_BINDING:-127.0.0.1:4173:4173}"
    networks:
      - resonance-net
      - caddy
    labels:
      # 生产环境 Caddy 配置（当域名变量不为空时生效）
      caddy: ${CADDY_WEB_DOMAIN:-}
      caddy.reverse_proxy: "{{upstreams 4173}}"
      caddy.encode: gzip
      # Watchtower 自动更新
      com.centurylinklabs.watchtower.enable: "true"

  # Watchtower - 自动更新容器（仅生产环境）
  watchtower:
    image: containrrr/watchtower:latest
    container_name: resonance-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # 每 60 秒检查一次镜像更新
      - WATCHTOWER_POLL_INTERVAL=60
      # 自动清理旧镜像
      - WATCHTOWER_CLEANUP=true
      # 只监控带有特定 label 的容器
      - WATCHTOWER_LABEL_ENABLE=true
      # 通知配置（可选）
      # - WATCHTOWER_NOTIFICATIONS=shoutrrr
      # - WATCHTOWER_NOTIFICATION_URL=telegram://token@telegram?channels=chat_id
    labels:
      com.centurylinklabs.watchtower.enable: "false" # Watchtower 不监控自己
    profiles:
      - production # 只在生产环境启用

networks:
  caddy:
    external: true
    name: caddy
