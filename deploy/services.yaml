# =============================================================================
# Resonance 服务编排配置
#
# 本地开发模式：
#   DEPLOY_ENV=local docker compose -f deploy/base.yaml -f deploy/services.yaml up -d
#   - 暴露 Gateway (8080) 和 Web (4173) 端口到 127.0.0.1
#   - 不使用 Caddy
#
# 生产模式（使用宿主机 Caddy）：
#   DEPLOY_ENV=production docker compose -f deploy/base.yaml -f deploy/services.yaml up -d
#   - 不暴露端口到宿主机
#   - 通过 Caddy labels 让宿主机 Caddy 反向代理
#   - 需要先在宿主机安装 Caddy 并配置 Docker 集成
# =============================================================================

x-resonance-build: &resonance-build
  context: ..
  dockerfile: deploy/Dockerfile
  target: final
  args:
    CGO_ENABLED: "${CGO_ENABLED:-0}"

x-resonance-service: &resonance-service
  image: ${RESONANCE_IMAGE:-ceyewan/resonance:local}
  build: *resonance-build
  environment: &resonance-env # 环境配置
    RESONANCE_ENV: ${RESONANCE_ENV:-}
    RESONANCE_DEBUG_CONFIG: ${RESONANCE_DEBUG_CONFIG:-false}
    # MySQL 配置
    RESONANCE_MYSQL_PASSWORD: ${RESONANCE_MYSQL_PASSWORD:-}
    # JWT 认证配置
    RESONANCE_AUTH_SECRET_KEY: ${RESONANCE_AUTH_SECRET_KEY:-}
    RESONANCE_AUTH_ISSUER: ${RESONANCE_AUTH_ISSUER:-}
    RESONANCE_AUTH_ACCESS_TOKEN_TTL: ${RESONANCE_AUTH_ACCESS_TOKEN_TTL:-}
  networks:
    - resonance-net
  restart: unless-stopped

services:
  logic:
    <<: *resonance-service
    hostname: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
      RESONANCE_MYSQL_HOST: mysql
    container_name: resonance-logic
    command: ["-module", "logic"]
    depends_on:
      - mysql
      - redis
      - etcd
      - nats
    labels:
      com.centurylinklabs.watchtower.enable: "true"

  gateway:
    <<: *resonance-service
    hostname: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    container_name: resonance-gateway
    command: ["-module", "gateway"]
    depends_on:
      - logic
      - redis
      - etcd
      - nats
    # 本地开发：暴露端口；生产环境：通过 Caddy labels
    ports:
      - "${GATEWAY_PORT_BINDING:-127.0.0.1:8080:8080}"
    networks:
      - resonance-net
      - caddy
    labels:
      # 生产环境 Caddy 配置（DEPLOY_ENV=production 时生效）
      caddy: ${CADDY_GATEWAY_DOMAIN:-}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.encode: gzip
      # Watchtower 自动更新
      com.centurylinklabs.watchtower.enable: "true"

  task:
    <<: *resonance-service
    hostname: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
      RESONANCE_MYSQL_HOST: mysql
    container_name: resonance-task
    command: ["-module", "task"]
    depends_on:
      - mysql
      - redis
      - nats
      - etcd
      - gateway
    labels:
      com.centurylinklabs.watchtower.enable: "true"

  web:
    <<: *resonance-service
    hostname: ${RESONANCE_WEB_HOSTNAME:-web-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_WEB_HOSTNAME:-web-service-001}
    container_name: resonance-web
    command: ["-module", "web"]
    depends_on:
      - gateway
    # 本地开发：暴露端口；生产环境：通过 Caddy labels
    ports:
      - "${WEB_PORT_BINDING:-127.0.0.1:4173:4173}"
    networks:
      - resonance-net
      - caddy
    labels:
      # 生产环境 Caddy 配置（DEPLOY_ENV=production 时生效）
      caddy: ${CADDY_WEB_DOMAIN:-}
      caddy.reverse_proxy: "{{upstreams 4173}}"
      caddy.encode: gzip
      # Watchtower 自动更新
      com.centurylinklabs.watchtower.enable: "true"

  # Watchtower - 自动更新容器（仅生产环境）
  watchtower:
    image: containrrr/watchtower:latest
    container_name: resonance-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # 每 60 秒检查一次镜像更新
      - WATCHTOWER_POLL_INTERVAL=60
      # 自动清理旧镜像
      - WATCHTOWER_CLEANUP=true
      # 只监控带有特定 label 的容器
      - WATCHTOWER_LABEL_ENABLE=true
      # 通知配置（可选）
      # - WATCHTOWER_NOTIFICATIONS=shoutrrr
      # - WATCHTOWER_NOTIFICATION_URL=telegram://token@telegram?channels=chat_id
    labels:
      com.centurylinklabs.watchtower.enable: "false" # Watchtower 不监控自己
    profiles:
      - production # 只在生产环境启用

networks:
  caddy:
    external: true
    name: caddy
