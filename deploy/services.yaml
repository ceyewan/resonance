# =============================================================================
# Resonance 服务编排配置
#
# 本地开发模式：
#   DEPLOY_ENV=local docker compose -f deploy/base.yaml -f deploy/services.yaml up -d
#   - 暴露 Gateway (8080) 和 Web (4173) 端口到 127.0.0.1
#   - 不使用 Caddy
#
# 生产模式（使用宿主机 Caddy）：
#   DEPLOY_ENV=production docker compose -f deploy/base.yaml -f deploy/services.yaml up -d
#   - 不暴露端口到宿主机
#   - 通过 Caddy labels 让宿主机 Caddy 反向代理
#   - 需要先在宿主机安装 Caddy 并配置 Docker 集成
# =============================================================================

x-resonance-build: &resonance-build
  context: ..
  dockerfile: deploy/Dockerfile
  target: final
  args:
    CGO_ENABLED: "${CGO_ENABLED:-0}"

x-resonance-service: &resonance-service
  image: ${RESONANCE_IMAGE:-ceyewan/resonance:v0.1}
  build: *resonance-build
  environment: &resonance-env
    RESONANCE_ENV: prod
    RESONANCE_DEBUG_CONFIG: "true"
  volumes:
    - ../configs:/app/configs
    - ../.env:/app/configs/.env:ro
  networks:
    - resonance-net
  restart: unless-stopped

services:
  logic:
    <<: *resonance-service
    hostname: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
      RESONANCE_MYSQL_HOST: mysql
    container_name: resonance-logic
    command: ["-module", "logic"]
    depends_on:
      - mysql
      - redis
      - etcd
      - nats

  gateway:
    <<: *resonance-service
    hostname: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    container_name: resonance-gateway
    command: ["-module", "gateway"]
    depends_on:
      - logic
      - redis
      - etcd
      - nats
    # 本地开发：暴露端口；生产环境：通过 Caddy labels
    ports:
      - "${GATEWAY_PORT_BINDING:-127.0.0.1:8080:8080}"
    networks:
      - resonance-net
      - caddy
    labels:
      # 生产环境 Caddy 配置（DEPLOY_ENV=production 时生效）
      caddy: ${CADDY_GATEWAY_DOMAIN:-}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.encode: gzip

  task:
    <<: *resonance-service
    hostname: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
      RESONANCE_MYSQL_HOST: mysql
    container_name: resonance-task
    command: ["-module", "task"]
    depends_on:
      - mysql
      - redis
      - nats
      - etcd
      - gateway

  web:
    <<: *resonance-service
    hostname: ${RESONANCE_WEB_HOSTNAME:-web-service-001}
    environment:
      <<: *resonance-env
      HOSTNAME: ${RESONANCE_WEB_HOSTNAME:-web-service-001}
    container_name: resonance-web
    command: ["-module", "web"]
    depends_on:
      - gateway
    # 本地开发：暴露端口；生产环境：通过 Caddy labels
    ports:
      - "${WEB_PORT_BINDING:-127.0.0.1:4173:4173}"
    networks:
      - resonance-net
      - caddy
    labels:
      # 生产环境 Caddy 配置（DEPLOY_ENV=production 时生效）
      caddy: ${CADDY_WEB_DOMAIN:-}
      caddy.reverse_proxy: "{{upstreams 4173}}"
      caddy.encode: gzip

networks:
  caddy:
    external: true
    name: caddy
