# =============================================================================
# Resonance 服务编排（使用 caddy-docker-proxy 反向代理 Gateway & Web）
# 运行方式：
#   docker compose -f deploy/base.yaml -f deploy/services-caddy.yaml up -d
# =============================================================================

services:
  caddy:
    image: lucaslorentz/caddy-docker-proxy:ci-alpine
    container_name: caddy-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    environment:
      - CADDY_INGRESS_NETWORKS=caddy
    networks:
      - caddy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - caddy_data:/data
      - caddy_config:/config
      - ../web/dist:/srv/web:ro
    labels:
      caddy_controlled_server: ""
      caddy_0: chat.ceyewan.xyz
      caddy_0.root: /srv/web
      caddy_0.encode: gzip
      caddy_0.file_server: ""
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  logic:
    image: ceyewan/resonance:v0.1
    restart: unless-stopped
    volumes:
      - ../configs:/app/configs
      - ../.env:/app/configs/.env:ro
    networks:
      - resonance-net
    hostname: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
    environment:
      RESONANCE_ENV: prod
      RESONANCE_DEBUG_CONFIG: "true"
      HOSTNAME: ${RESONANCE_LOGIC_HOSTNAME:-logic-service-001}
    container_name: resonance-logic
    command: ["-module", "logic"]
    depends_on:
      - mysql
      - redis
      - etcd
      - nats

  gateway:
    image: ceyewan/resonance:v0.1
    restart: unless-stopped
    volumes:
      - ../configs:/app/configs
      - ../.env:/app/configs/.env:ro
    hostname: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    environment:
      RESONANCE_ENV: prod
      RESONANCE_DEBUG_CONFIG: "true"
      HOSTNAME: ${RESONANCE_GATEWAY_HOSTNAME:-gateway-service-001}
    container_name: resonance-gateway
    command: ["-module", "gateway"]
    depends_on:
      - logic
      - redis
      - etcd
      - nats
    expose:
      - "${RESONANCE_GATEWAY_HTTP_PORT:-8080}"
      - "${RESONANCE_GATEWAY_WS_PORT:-8081}"
    networks:
      - resonance-net
      - caddy
    labels:
      caddy: im-api.ceyewan.xyz
      caddy.reverse_proxy: "{{upstreams ${RESONANCE_GATEWAY_HTTP_PORT:-8080}}}"
      caddy.route.1: "/ws*"
      caddy.route.1.reverse_proxy: "{{upstreams ${RESONANCE_GATEWAY_WS_PORT:-8081}}}"
      caddy.encode: gzip

  task:
    image: ceyewan/resonance:v0.1
    restart: unless-stopped
    volumes:
      - ../configs:/app/configs
      - ../.env:/app/configs/.env:ro
    networks:
      - resonance-net
    hostname: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
    environment:
      RESONANCE_ENV: prod
      RESONANCE_DEBUG_CONFIG: "true"
      HOSTNAME: ${RESONANCE_TASK_HOSTNAME:-task-service-001}
    container_name: resonance-task
    command: ["-module", "task"]
    depends_on:
      - mysql
      - redis
      - nats
      - etcd
      - gateway

networks:
  resonance-net:
    external: true
    name: resonance-net
  caddy:
    external: true

volumes:
  caddy_data:
  caddy_config:
