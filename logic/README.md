# Logic æœåŠ¡

Logic æ˜¯ Resonance IM ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æœåŠ¡ï¼Œå¤„ç†æ‰€æœ‰ä¸šåŠ¡ç›¸å…³çš„è¯·æ±‚ã€‚

## ğŸ“ æ¶æ„è®¾è®¡

### æ ¸å¿ƒèŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    gRPC     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    MQ      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Gateway   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    Logic    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Task   â”‚
â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚            â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Response   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  MySQL    â”‚
                       â”‚  Redis    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸šåŠ¡å¤„ç†æµç¨‹**ï¼š

1. **æ¥æ”¶è¯·æ±‚** - é€šè¿‡ gRPC æ¥æ”¶æ¥è‡ª Gateway çš„è¯·æ±‚
2. **ä¸šåŠ¡å¤„ç†** - éªŒè¯æƒé™ã€æŸ¥è¯¢æ•°æ®ã€æ‰§è¡Œä¸šåŠ¡é€»è¾‘
3. **æ¶ˆæ¯å‘å¸ƒ** - å°†éœ€è¦å¼‚æ­¥å¤„ç†çš„ä»»åŠ¡å‘å¸ƒåˆ° MQï¼ˆå¸¦ Outbox ä¿è¯ï¼‰
4. **è¿”å›å“åº”** - å°†å¤„ç†ç»“æœè¿”å›ç»™ Gateway

### ç›®å½•ç»“æ„

```
logic/
â”œâ”€â”€ logic.go                # ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€ç»„ä»¶ç»„è£…ã€ä¼˜é›…å…³é—­
â”œâ”€â”€ config/                 # é…ç½®å®šä¹‰ä¸åŠ è½½
â”‚   â””â”€â”€ config.go           # Config ç»“æ„ä½“ + OutboxConfig
â”œâ”€â”€ server/                 # gRPC Server å°è£…
â”‚   â””â”€â”€ grpc.go             # æ‹¦æˆªå™¨ï¼ˆæ—¥å¿—ã€æ¢å¤ï¼‰ã€åˆ†çº§æ—¥å¿—ç­–ç•¥
â”œâ”€â”€ service/                # ä¸šåŠ¡æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ auth.go             # è®¤è¯æœåŠ¡ï¼ˆLogin/Register/ValidateTokenï¼‰
â”‚   â”œâ”€â”€ session.go          # ä¼šè¯æœåŠ¡ï¼ˆGetSessionList æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ï¼‰
â”‚   â”œâ”€â”€ chat.go             # èŠå¤©æœåŠ¡ï¼ˆSendMessage + MQ å‘å¸ƒï¼‰
â”‚   â”œâ”€â”€ presence.go         # åœ¨çº¿çŠ¶æ€æœåŠ¡
â”‚   â”œâ”€â”€ helpers.go          # å…¬å…±å‡½æ•°ï¼ˆPublishMessageToMQï¼‰
â”‚   â””â”€â”€ interfaces.go       # æœåŠ¡æ¥å£å®šä¹‰ï¼ˆä¾¿äºæµ‹è¯•ï¼‰
â”œâ”€â”€ job/                    # åå°ä»»åŠ¡
â”‚   â””â”€â”€ outbox.go           # Outbox è¡¥å‘ï¼ˆWorker Pool å¹¶å‘ï¼‰
â”œâ”€â”€ observability/          # å¯è§‚æµ‹æ€§
â”‚   â”œâ”€â”€ observability.go    # Trace/Metrics åˆå§‹åŒ–ã€è¾…åŠ©å‡½æ•°
â”‚   â””â”€â”€ config.go           # å¯è§‚æµ‹æ€§é…ç½®
â””â”€â”€ README.md
```

## âš™ï¸ é…ç½®è¯´æ˜

é…ç½®åŠ è½½é¡ºåºï¼šç¯å¢ƒå˜é‡ > `.env` > `logic.{env}.yaml` > `logic.yaml`

### æ ¸å¿ƒé…ç½®é¡¹

```yaml
service:
    name: logic-service
    server_addr: :15090

observability:
    trace:
        disable: false # æ˜¯å¦ç¦ç”¨ Trace ä¸ŠæŠ¥
        endpoint: localhost:4317 # OTLP Collector åœ°å€
        sampler: 1.0 # é‡‡æ ·ç‡
    metrics:
        port: 9091 # Prometheus ç«¯å£
        path: /metrics

outbox:
    batch_size: 100 # æ¯æ¬¡å¤„ç†çš„æ¶ˆæ¯æ‰¹æ¬¡
    max_retries: 5 # æœ€å¤§é‡è¯•æ¬¡æ•°
    ticker_time: 1s # æ‰«æé—´éš”
    worker_count: 5 # å¹¶å‘ Worker æ•°é‡
```

## ğŸ”‘ å…³é”®ç»„ä»¶

### AuthService (è®¤è¯æœåŠ¡)

- ä½¿ç”¨ `genesis/auth` (JWT) è¿›è¡Œ Token ç­¾å‘ä¸éªŒè¯
- å¯†ç ä½¿ç”¨ `bcrypt` åŠ å¯†å­˜å‚¨
- æ—¥å¿—è„±æ•ï¼šä¸è®°å½•ç”¨æˆ·åï¼Œé˜²æ­¢ç”¨æˆ·æšä¸¾æ”»å‡»

### SessionService (ä¼šè¯æœåŠ¡)

- **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**ï¼š`GetSessionList` ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢é¿å… N+1 é—®é¢˜
    - `GetUsersByUsernames()` - æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
    - `GetUserSessionsBatch()` - æ‰¹é‡è·å–ä¼šè¯æˆå‘˜
    - `GetLastMessagesBatch()` - æ‰¹é‡è·å–æœ€åæ¶ˆæ¯ï¼ˆå­æŸ¥è¯¢ä¼˜åŒ–ï¼‰

### ChatService (èŠå¤©æœåŠ¡)

- ä½¿ç”¨ Snowflake ç”Ÿæˆå…¨å±€å”¯ä¸€ MsgID
- æ¶ˆæ¯æŒä¹…åŒ–åˆ° MySQLï¼ˆäº‹åŠ¡ä¿è¯ï¼‰
- MQ å‘å¸ƒå¸¦ Outbox æ¨¡å¼ï¼ˆå¯é æ€§ä¿è¯ï¼‰
- è‡ªåŠ¨æ³¨å…¥ Trace Context åˆ° MQ æ¶ˆæ¯

### PresenceService (åœ¨çº¿çŠ¶æ€æœåŠ¡)

- æ¥æ”¶ Gateway ä¸ŠæŠ¥çš„ç”¨æˆ·åœ¨çº¿çŠ¶æ€
- æ›´æ–° Redis ä¸­çš„è·¯ç”±è¡¨ (`RouterRepo`)

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### N+1 æŸ¥è¯¢ä¼˜åŒ–

**ä¼˜åŒ–å‰**ï¼š50 ä¸ªä¼šè¯éœ€è¦ 150+ æ¬¡æ•°æ®åº“æŸ¥è¯¢
**ä¼˜åŒ–å**ï¼šä»…éœ€ 4 æ¬¡æŸ¥è¯¢ï¼ˆæå‡ 37.5 å€ï¼‰

```
1. GetUserSessionList       â†’ 1 æ¬¡æŸ¥è¯¢
2. GetLastMessagesBatch      â†’ 1 æ¬¡æŸ¥è¯¢ï¼ˆå­æŸ¥è¯¢ï¼‰
3. GetUserSessionsBatch      â†’ 1 æ¬¡æŸ¥è¯¢
4. GetUsersByUsernames       â†’ 1 æ¬¡æŸ¥è¯¢ï¼ˆIN æŸ¥è¯¢ï¼‰
```

### Outbox Worker Pool

**ä¼˜åŒ–å‰**ï¼šä¸²è¡Œå¤„ç†æ¶ˆæ¯è¡¥å‘
**ä¼˜åŒ–å**ï¼š5 ä¸ªå¹¶å‘ Workerï¼ˆæå‡ 5 å€ååé‡ï¼‰

### gRPC æ—¥å¿—åˆ†çº§

- é”™è¯¯è¯·æ±‚ â†’ Error çº§åˆ«
- æ…¢è¯·æ±‚ (>100ms) â†’ Warn çº§åˆ«
- æ­£å¸¸è¯·æ±‚ â†’ Debug çº§åˆ«ï¼ˆç”Ÿäº§ç¯å¢ƒä¸è®°å½•ï¼‰

**æ—¥å¿—å‡å°‘**ï¼š80%+

## ğŸ“Š å¯è§‚æµ‹æ€§

### Traceï¼ˆåˆ†å¸ƒå¼è¿½è¸ªï¼‰

- OpenTelemetry OTLP ä¸ŠæŠ¥
- è‡ªåŠ¨æ³¨å…¥/æå– Trace Context
- MQ æ¶ˆæ¯æºå¸¦ Trace Headersï¼Œå®ç°è·¨æœåŠ¡è¿½è¸ª

### Metricsï¼ˆä¸šåŠ¡æŒ‡æ ‡ï¼‰

| æŒ‡æ ‡åç§°                                | è¯´æ˜               | æ¡¶å€¼       |
| --------------------------------------- | ------------------ | ---------- |
| `logic_login_duration_seconds`          | Login è€—æ—¶         | 0.01~1s    |
| `logic_register_duration_seconds`       | Register è€—æ—¶      | 0.01~1s    |
| `logic_send_message_duration_seconds`   | SendMessage è€—æ—¶   | 0.005~0.5s |
| `logic_create_session_duration_seconds` | CreateSession è€—æ—¶ | 0.01~1s    |

è®¿é—® `http://localhost:9091/metrics` æŸ¥çœ‹ Prometheus æŒ‡æ ‡ã€‚

## ğŸ”’ å¯é æ€§ä¿è¯

### Outbox æ¨¡å¼

```
                    MQ å‘å¸ƒæµç¨‹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Logic     â”‚                   â”‚     MQ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ä¿å­˜æ¶ˆæ¯ â”‚                   â”‚             â”‚
â”‚ 2. ä¿å­˜ Outboxâ”‚ â”€â”€â”€â”€Look-asideâ”€â”€â–¶â”‚  ç«‹å³å‘å¸ƒ   â”‚
â”‚ 3. è¿”å›å“åº” â”‚     (å¼‚æ­¥é‡è¯•)     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚           Outbox Job            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (å®šæ—¶è¡¥å‘æœªå‘é€æ¶ˆæ¯)
```

- **äº‹åŠ¡ä¿è¯**ï¼šSaveMessageWithOutbox åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆ
- **å¼‚æ­¥å‘å¸ƒ**ï¼šPublishMessageToMQAsync ç«‹å³å°è¯•å‘å¸ƒ
- **æŒ‡æ•°é€€é¿é‡è¯•**ï¼šé‡è¯•é—´éš”ä¸º nÂ² ç§’
- **Worker Pool**ï¼š5 ä¸ªå¹¶å‘ Worker å¤„ç†ç§¯å‹

### ä¼˜é›…å…³é—­

```go
// 10 ç§’è¶…æ—¶æ§åˆ¶
// goroutine å¹¶å‘å…³é—­èµ„æº
// è¶…æ—¶åè®°å½•è­¦å‘Šä½†ç»§ç»­å…³é—­
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

```go
package main

import (
    "github.com/ceyewan/resonance/logic"
)

func main() {
    // åˆ›å»º Logic å®ä¾‹ (è‡ªåŠ¨åŠ è½½é…ç½®)
    l, err := logic.New()
    if err != nil {
        panic(err)
    }
    defer l.Close()

    // å¯åŠ¨æœåŠ¡
    if err := l.Run(); err != nil {
        panic(err)
    }

    // ç­‰å¾…å…³é—­ä¿¡å·
    <-l.Done()
}
```

## ğŸ“ å·²å®ç°åŠŸèƒ½

- [x] JWT Token ç­¾å‘ä¸éªŒè¯ï¼ˆæ¥å…¥ genesis/authï¼‰
- [x] å¯†ç  bcrypt åŠ å¯†
- [x] ç¾¤èŠ SessionID ç”Ÿæˆï¼ˆSnowflakeï¼‰
- [x] ç¦»çº¿æ¶ˆæ¯å¤„ç†ï¼ˆOutbox + MQï¼‰
- [x] N+1 æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰
- [x] Trace é“¾è·¯è¿½è¸ªï¼ˆOpenTelemetryï¼‰
- [x] Prometheus ä¸šåŠ¡æŒ‡æ ‡
- [x] gRPC åˆ†çº§æ—¥å¿—
- [x] æ—¥å¿—è„±æ•ï¼ˆé˜²ç”¨æˆ·æšä¸¾ï¼‰
- [x] ä¼˜é›…å…³é—­ï¼ˆè¶…æ—¶æ§åˆ¶ï¼‰

## ğŸš§ å¾…å®Œå–„åŠŸèƒ½

- [ ] æ¶ˆæ¯æ’¤å›
- [ ] æ¶ˆæ¯ç¼–è¾‘
- [ ] ç¾¤æˆå‘˜ç®¡ç†
- [ ] å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆ/healthzï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ•´ä½“ CLAUDE.md](../CLAUDE.md)
- [Gateway æœåŠ¡æ–‡æ¡£](../gateway/README.md)
- [Task æœåŠ¡æ–‡æ¡£](../task/README.md)
- [Genesis ç»„ä»¶æ–‡æ¡£](https://github.com/ceyewan/genesis)
